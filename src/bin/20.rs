use std::collections::*;
use itertools::Itertools;

static IMAGES: [(usize, [&str;10]); 144] = [(3583,[".##..#..#.","....##....","##..#..#..",".....#....",".#..#.....","#.#.......","#.....#..#","....#....#","...#.##.#.",".#....##.#"]),(3967,["..###..#..","#.........",".........#","#...#....#","....#....#","#...#....#","#..#...#.#","##....##..","#....#....","##.###.#.."]),(3307,[".#.#...#..","......#..#",".........#","##.....##.","..#.....#.",".#...####.","#....#.#.#","......##.#","#.##.#..##",".....#.##."]),(1741,[".##..#.#..","#..##.#...",".#.....#..","...####.##","#.#..###..","####.#....","..#.##.#..","#.....#.#.","#.###.....","####...###"]),(3821,[".#######.#","...#......","#.##.#...#",".#...#####","....#.##..","#.#.#.....","##......##","#..#.....#","##..#..#.#","###..#.#.."]),(1787,["..##.#.###","...##..#.#","#..#.###.#","..#.##..#.","#.#.....##","...#...#.#","#..##..#.#","##.#.##..#","...#..#...","..#..##..."]),(2281,["..#.#.##.#",".......##.","..#..#..#.","....#.#..#","#...#.##.#","#..#.##.#.","#.#....#.#","#....##...",".....#..##","...#.#...#"]),(3593,["...#..#..#",".........#",".........#","#.#..#...#","##......##","##........","...#.#...#","#...#...##","...#.#.#..","#..#......"]),(3259,[".####.....","....#.#.##","#....#..##","#........#",".....#....",".#.....#.#","...##....#","#.....#.#.","#.#..#....","#.#..##.#."]),(2663,[".####..###","#.#..##...","#..#...#..","#..#....#.","..#.##...#",".#....#.#.","#..#....#.","#.#.......",".#.#......","..#..#####"]),(3833,["####....#.",".......#.#",".#........","#...#.##.#","#.##.#.#.#","...#.....#","##...#...#","#.#.##...#","##.#.#.##.",".##.###.##"]),(3373,["#.....##.#","#...###..#","..#.#..#..","####..#.##","#...#.##.#","#..##.#...","#..##...##","#.####....","##..#...#.","##.##.#.##"]),(1511,[".#.###...#","#....#...#",".##.#.....","...##.###.","#.##.##..#","####.#..##","#..#.#....","#.......#.","#......#.#","###...#..."]),(1723,["...##..#.#","..#..#...#",".##.....#.","#..#......",".#..#.#..#",".#........","...#.#..##","##.......#","..#..###..","#####...##"]),(1543,["#..#.##.##","#.....#..#",".....#.#.#","###.......","...##....#","..#..#...#","#.....##.#","#.#..##.##","...###....","###.#...#."]),(1433,["##.##..##.","###....#.#","..#.....##",".#.##..#..",".#.#...###","#.#.....#.","..##.....#","#....#....","..#.#...#.",".#...#####"]),(1949,["#.#..##..#",".........#",".#.......#","#..##..###","........##","#........#",".....#...#","...####.#.",".#...##...","###.#.#..#"]),(3889,["###...####","#....##..#",".#.###...#","##..#.....",".....#....","....#.#.#.",".........#","#....##..#","##.##..##.","#.###.####"]),(2477,[".....#..##","#.##.###..","###..#...#",".#....#.#.","#..#......","...#.....#","##.....#..","..##.....#",".##.#....#","#####.####"]),(2137,["..########","#..#......","...#.##..#","#.#..#...#",".#..#...##","##.....#.#",".#....##..",".##.......",".#..####..","#..###...#"]),(3313,["..####.#.#","#..#.....#","#....#....","..##..##..","#....##...","..........","#.........",".......###","##........",".###...###"]),(1493,["#..####.##","##.#..#...","#.#.....##",".##......#",".##...#..#","#..##....#","#.#.#.#.#.","#.#...#..#","#.#.#....#","#.####...#"]),(1579,[".##..##.##","#.#.......",".......#..","..#...##..","#..####...",".#.#.##.##","###.#.....","#....##.##","....#...##","##....#.#."]),(2221,[".#.#......",".......##.","#..#.#...#","..###.###.","....#...##","##.#..##..","..##.#.#..","......####","..##.#.#..",".###..#.##"]),(3643,["..###...#.","#..#..#..#",".##.......","#..###....","##...##.##","#...#...#.","###......#","....#..#.#",".#.#.....#","..#..#.#.."]),(3881,["###.##.##.",".####..###","#.###..##.","....#...#.","##...#..#.","#........#","....#...#.","...#.....#",".#.....##.",".####..#.#"]),(3823,["..#.##..##","#...#....#","..#...#...","#.#.##...#",".####....#",".#...#...#","..........",".........#","...#..#...","....#..#.#"]),(3181,["####..##.#","#.....##.#","#.......##",".......#.#","..#..##.#.","##..#..#..","...##.....",".........#","....#.##..",".##.###.#."]),(2837,[".###.#.###","#.##..#.##",".....##...","###......#","##.......#","........##","##.##..#..","....###...","..........","#......#.#"]),(2063,["..#####...","..........","........#.","..##.....#","###...#.#.","#.#.....#.",".....#..##","#.......#.","##....##..","#.##.###.#"]),(1187,["#...##..##","#........#","#.#.......","...#.#....",".....#.#.#","#....#....","..###.....",".#........","..#...###.","####.#.#.#"]),(3137,["...###..#.","#.##.....#","..#...#..#","#..#.....#","......#...","#.....##.#","...#......","#.#.#.####","..#....#..",".#..#.#.##"]),(2411,["#.....##..",".......#.#",".....##...","#.#.......","#..##....#",".##.##....",".##...##..","#.#.......","##.....#.#",".##.###..."]),(2713,["..#.#.####","...####.#.","##..#...#.","#..##.....","#...#.....",".#...#.###","..........","#.#.##..#.","#.#..#..#.",".#..##.#.#"]),(1103,["##.#...##.","#.....##..","...###..#.","..##.....#",".####..#..","..#.###.#.","##.....#..",".#..#....#","#........#","####...##."]),(3943,[".###......","#...#.#...","..##..#..#",".##..#.#.#","..........","##...#....","#..#...#..","#..###...#","###....###","#.#....###"]),(1871,["##.#...##.","#......#..",".#.##.....",".#####.#..","#.#....#..","#..#....##","#..####.#.","#....#....","...#.....#","...#.##.#."]),(3407,["#.#.#####.","##.#..#..#",".###.#.#.#","..#.......","##.###.#..",".....#.###","#.#.......","##..#.#..#","#.#.##.#.#","#..#..###."]),(2441,["#####.#..#","...#.#....","..#...#..#",".##....#..","#.##..#...",".##.#..#.#","##.......#",".##..#....",".......#..",".#..#.###."]),(3637,[".#..##.#.#","...##..#..","#.#.###...","#....#...#","..#.....##","#....#...#","#..#.#.#..","....#..#.#","....#.#..#",".#.###.##."]),(1549,["....##.##.",".#....#...","..####.#..","....#.#..#","#........#","..#.......",".#.#....##","...######.","#...##....",".#...##..."]),(1481,["...##.##..","#...#.##..","#..#..#.#.","#.#.#...#.","#...#.##..",".##....#..","#........#","....#.#...","#.#.....##","#.....####"]),(1559,["#..#....#.","..#.##.#.#","#.....#.##",".###.#...#","..####..##","#..#.#..#.","#.#...###.","#.....#.#.",".#.....#..","#..####.#."]),(2251,["#..#.....#",".#..#.....","#.#....#..","#....##..#","##....#..#","..#..#....","#.#.#.#...","#...#....#","###..#.##.","##..#.####"]),(2897,["...###....","##..#....#",".........#",".#.......#","...#.....#","..#..#...#",".#...#...#","#....#....",".#......##","..##...##."]),(2239,["#..###..#.",".#.......#",".#..#..#..","#.##....##","#....#.#.#","##..#.....","#........#","...##.#..#","#...###..#","...#.#.###"]),(2593,[".#....##.#","##......##","..#..##...",".#..#.....","...#.#...#","#.#..#.#..","......#.#.","#...##...#","###..##..#","#.#####.##"]),(3697,["##.######.","###....#..","#.....##.#","##...#..##","#.....#..#",".#.#..#...","#......##.","#.#.#.#.#.",".........#","....####.."]),(3739,["##.#......",".#.....#.#","..#.....##","#....##...","##.#...#..","###.#...##",".#...#.###",".#..#.##.#","..#..#..#.","...#.##..."]),(2459,[".#.####...","#..#...#..",".....#.##.","..#....##.","#......##.","##...#..##","#....#....","###...#..#","###.##.###",".....##..."]),(2939,["##.#.#....","#..#.#####","#...###.#.","..#...#.##",".#.....##.","###....#..",".##...#..#",".....#.#..","..#..#....","..##..#.##"]),(2347,[".###..#..#","##......#.","#......#..","#...#....#","#......#..","##.......#","..#.......","#.##..#...","#..#..###.","#....##..#"]),(2381,["######....","##.......#",".#....###.","#.##.##.#.","#.#..#....",".........#","....#..#.#","#####.....","..##....##","#..###...#"]),(2503,["#.#...###.","#...#..#..",".##.#.#.##",".#.....#..","#...##....","##.#.....#","...#..#..#","..#.##...#","......#...","##..#..##."]),(3023,[".#...#....","#.##...#..","##....#...",".#..#.....",".#.#.....#","#.#.......","##..#.#.#.","#...#.#...","...#..#.##","#...##.###"]),(3851,["#..##.#.#.","#...#....#","###..#....","#.#.#...##","..#.#..#.#","#.......#.","..#.....##","..........","#.#.#.#..#","..#.##..#."]),(1009,[".####.##..","#.........",".#.#......","..#.#.....","#......##.","###.......","#.#.......",".......#.#",".#....#.##","#.####.#.#"]),(1151,[".#.##..#..","..#......#","##....##.#","#......###","##.....#..","##..#.#..#","...#......",".##...##..","##..###..#","######.###"]),(2683,["#..#.#..##",".#....#.#.","#...##....","....###...","...#..#...","..#.......","...#...#..","....#.#...","..#..#...#","..#.#.##.."]),(3323,["#.#..##.##","#.#....###","#.##.###.#","##....#...","##..#.....","###.#.#.##","#......#.#","..#....##.","#......#.#",".##...#..#"]),(2333,["##.#..#..#","#..##.....",".........#",".#.#.#....","#...##...#","#.#.#....#","..#.###..#","....###.#.","#...#....#","..#.....#."]),(2543,["#..###.#..","....#..#.#","..#...#.#.","#...##...#",".#.....###","..........","#..#....#.","#....#..#.","#.#..##..#","##...#..##"]),(1483,["###..##..#",".#......#.",".......#.#","#........#","...#...#.#","#.#.#.....","#......#.#","#...#.#...","#...####..","#.##..#..#"]),(2027,[".#..#....#","....##....","....#...##","#.#..#....","#.#.....##",".......#.#","#...#.....",".##....#.#","###.#.##.#",".###.#.###"]),(1699,["#.###..##.","..#.###...",".........#",".#.#..#..#","...##.##..","#........#",".......#.#","##..#...##",".....#....","#########."]),(2843,["#...#.####","....#.##..","...#....#.",".....#....","#..##.....",".....#....","###.#.....","......#..#","#.#.#...##","#...##.##."]),(1597,["#..#######","..........",".#........","#..##.#...","##.....#..","##.###...#",".....###.#","...##.#..#","#....#...#","##.#.#####"]),(2311,[".#.#.#.###",".#.......#","..#...#.##","#..#....##","#...#.....",".........#",".#.#...##.",".#.##....#","..#..#...#","...##.#.#."]),(1889,["#.###.###.",".#...#...#","#........#","#......#.#","..#......#","#......###",".....#.##.","#.....#..#","........##","####...#.#"]),(3581,["........##",".#...#...#","###.....#.","..........","#.#......#","......#..#","##........","..#...####","#..#......",".##.###.##"]),(1499,["##.#.#....",".##...##..","##.....##.","###.#...##","..##....#.",".#....#...","#..#...##.","..#....##.",".#.....#..","..#.####.#"]),(2999,[".#.###..#.","#.#...#...","##.#......","...#..#...","..###..###","...#.#..#.","#..##.#..#",".........#","..#....##.","..#.###.#."]),(1487,["#....#....",".#.....#..",".#.#.....#","#.#......#","#.#.##....","#.....#...",".....#....","##........","##..##...#","#.#..#...#"]),(2969,["#..#.#..##","###..#...#",".#..#.....","...####.#.","#.#.##..#.","...###...#","#...#.....","..#...##..","##..#.#..#","#..#.###.#"]),(1873,["..###.#.#.","..#.###.#.","#.#.##...#",".#...#...#","....#.....","##.....##.",".....#.#..","..#..#..#.","..##..#..#","##...#...."]),(2029,["#.#...####","#....##...",".#.#...##.","#####.#.#.","#..#......","#...#..#..","#.#.#..#.#","#......#.#","...####.#.","..##.#.###"]),(3517,[".##...##..",".#......#.","....##....","#.##..#..#",".......##.","#..#......","...##...#.","........##","#...#....#","..######.#"]),(2803,["#.##.###..",".#..##...#","...##.....",".#.#.#.#..","#.......#.",".##.#.#..#",".#.###.#..",".#..#...##","#...###...",".###..#.##"]),(1237,[".######.##","#.#.......","....#....#",".....#...#","#.###.#.##","#...####..","#.#......#","#.#.##.#.#","#..#..#...",".#..#....#"]),(3877,["..#.#.#.##","..##...#..","#..#...#..","#.......#.","#.......#.","#...#.##..",".#.......#","....#..###","##.......#",".#.##.#.#."]),(2081,["####.#####","....#..##.","........##","....#..##.","#..#....#.",".##...##..","......#...",".#....#..#","#.#.#...##",".##...##.#"]),(2789,[".#.##..#.#",".......#..","##.......#","..#..#..##","..#.......",".#........","#..##.#.#.","###.#..###","##..#...##","..#..#...."]),(3989,["##.##...##","#....#..#.",".#....#.##","#......#.#","#.#..#....","#....#.#.#","...#...#..","#........#",".......#.#","##.##.##.."]),(1933,[".....###.#","#...#.#..#",".#....#..#",".#........","#####.##..","#..#.#...#","#..#.#...#","....##....","#....#..#.","##..#..##."]),(1601,["##.#..##..",".#.###.#.#","..#.###..#","##.#.#....",".....###.#","##.##.####","#.#...#..#","#...##....","...#......",".####..###"]),(1117,["#..##..##.","......##.#","....##.#..","#....#....",".#.#.....#",".....#.##.","#....##...","#.....#...","..#..##.#.",".#.###.#.."]),(1409,["#...###...","#......#..","........#.",".#........","##....#...","#.......##","#......#..","......##.#","#..###.#..",".####.##.."]),(3359,["##.##....#","#..#...#.#","#....#####","...##..#..","..#..#...#","........##","...#...#.#",".........#","...#.#.#.#","##.#....##"]),(2539,["...##.##.#","#.##.#...#","...##.#...","..#.#..#..","#.#..#.###","......##.#","#.......#.",".#.......#","#...####..","..#...###."]),(1607,["##..###.#.","#...#....#","#.#.#..#..","#..#....##","#.#......#","....##....","#..###...#","..#.##..##","##....##.#","...##..###"]),(2971,["#....#..##",".##......#","#..##.....","#...##.##.","#...#.##..","....##...#","..#.###...","##.#.#..##","#..#..###.","#...###.##"]),(2447,["#..#..##.#","#....##..#",".....##...","..#.###..#","#..#.##...","#.#.#...##","#.#..###.#","####..#...","#.#...###.","#..###..##"]),(1709,[".....#..##","##....#...",".........#","...###..#.","###......#","..#..#...#","#.###.#..#","###....##.","...#..##.#","##.#...#.."]),(3109,[".#..###.##","....#.#.##","..#...#..#","#...#.....","####.#....",".#.#...###","###....#..","#..###....","..........","##.##...##"]),(2089,["..####..#.",".###.....#","....#..###",".#.......#","..##.....#","#.###....#","#.#.##.#.#","#.......#.","...#.##.#.","...#..#.##"]),(1619,["#...#.#.#.","#.........","#....##.##","##....#...","#####.....","##.#..#..#","###...#..#","...#......","##..#....#",".##.##...#"]),(3319,["###.#.#.#.",".#....#..#","#.#.#...##","...#.....#","..........","........#.","..........","...#.##..#","#.#.#....#","##......#."]),(1621,["#.###.###.",".#...#...#","#.#......#","#....#....","#..#.....#","##..#..#..",".###..#.#.","#.#.#.####","#.......##","##.##...#."]),(2857,["##.#.#.#..","...#...##.","#......#..","......#...",".#.#..#...",".##..#...#","..###....#","#.##......","#.###...##","..#..##.#."]),(2143,["#.#.......","#...#.##..","#..#.....#","...#.....#","#...#....#","........##","##....#.##","##..##..#.","#..#.....#","#..##....#"]),(3037,["........##","#....#..#.","......#...","....#.#...","...###.###","...###...#","..........","#.....#..#","##..#.....","#....#...."]),(1733,["#.#..#.#..",".#....##..","#..#.#...#","........#.",".........#","##....#...","#.....#..#","#..####.#.","#...##....","..#....##."]),(2657,[".##...#..#","#...#.##..","##........",".##......#",".#...#...#","..##...#..",".........#","....#...#.","..#.##...#","#..######."]),(1451,["#.....#..#",".....#.##.","......##..","..#.......","..........","#..##....#","###......#","##.#.....#","#...##.###","###.#....."]),(3191,["####.#.#.#",".........#","###.#####.","#.....##..","...#....#.","##..#....#",".#..#.#..#","#........#","######..#.",".####.####"]),(3163,[".#.##.#..#","##.##.#.#.","##..#....#",".#....#.#.","##.#.....#",".#........","#.#......#","#.......##","#........#","###...###."]),(3067,[".#...##...","..###.....","##.#..#..#","##.##..#..",".......#..","#...##.#..","####....#.","#.#....#..","........#.",".##.#....#"]),(3203,["##...#.#.#",".##..#####","#.......##",".#....#...",".#....#..#","..#.#....#","#....#.#..","#....#####","#...####..","....##.###"]),(3229,["...#......","#...#.....","..##.#.##.","#.#...#...","#.##.#..##","##....##..","..#.###..#",".....#...#","...#.....#","..#.#....."]),(2083,["....#.###.","..........",".........#","...##..#.#",".##..#....","#..#..#...","......#.#.","#........#","#.##......","###..#.###"]),(3253,[".##..#.#..",".#.#...#.#","#.#....#..","...#.....#","#.........","#.........",".##......#","......###.","#.........",".....#...#"]),(1381,["###...##.#","#.#####.#.","###..#..##","#.........","..#..#...#","..#.#...##",".#.#.....#","..#...##.#","##.#..#..#","######...."]),(2113,[".....##..#",".....###..","...#.....#","##.#..#...","....#.....","...#......","#..###.#.#","..........","#.#.......","..#..#.#.."]),(1087,["###..#.##.","#....#....","..#......#","###.#....#",".#.......#","..#....##.","#...#....#","....#...##","....#.#.#.","#.#..#.###"]),(2833,[".....#...#","#...#.#.#.","#.......#.","#......#.#",".#.##.#...","........##","....#.#.##","........##","......#.#.","######.#.."]),(1063,[".....###.#","#####.#..#","..###....#","...#.##...","###....#.#",".....##...","####.....#","..##.#....","#...#...#.","...##.###."]),(3049,["#.#.#..###","...##....#","#..#..#.#.","##.##..#..","###.....##","#.#..#.#..","#..##....#","#.#...#..#","##..#..#.#","....#####."]),(1657,["#..####...","........##",".........#","#...#.#...","#.#......#",".#.#....#.","#....###.#","#..####.#.","#..#..####","...###..#."]),(3863,["##.#######","..#.#.#...","#....#..#.","........##","#.##......","....#.....","#.#..##...","#.#......#","..#..#.#..","##.####..#"]),(3083,["##.#...###",".#..#..#..","#.#####...","#..#.#....","##.....#..","#..##..###",".#.#.....#","#.#..#..##",".#.#..#.##","...#......"]),(3853,["#.###..###","##..#..##.",".....##.##","......#..#","...#.#..#.","###....#..","##.....#..","##........","...#..#..#","###.###..#"]),(2129,["..#....#.#","#...#.....","##...##..#","#.#.......","....#.....","##......##","#..#......","#..#..#...","..........","...#.#.#.."]),(1759,["..##..###.",".......#..",".#.#.....#",".....#....","#......#.#","#.#......#","#..#.#.#.#","#..#.#...#","#.#...#..#",".##....#.#"]),(3617,["..#.#..###","..###....#","##.#.....#","#.##....##",".....#..#.",".........#","..........",".####..#.#","#.#...#.#.","....##.##."]),(2017,["..#.##.#.#","....#...##","..........",".#........","#.....#...","#.....#...","#.........","....#.#.#.","..#.......","..#...#.##"]),(1277,["..##...#.#",".##..#..#.",".#....##.#","#....##...","#..#.##..#","###..##..#",".........#",".##.#.....","..#.......","##.###.#.."]),(2617,["###.......","......#...","##.##..#..","#.#....#..",".###....##","..###..#.#","##...##..#","#..#......","#..#..####","#.##..#..."]),(2719,["..#.#.##.#","........##","...#.#....","...##....#",".#.##.#...","..#.##.###","##.#.....#",".........#","..#.#...##","###.#..###"]),(3671,["#..##..###","#...#...##","..........","...##.....",".#..#.#..#","#.#..#....","#..###.###","..##..####","#.........",".#..#.#..#"]),(3389,[".#....#.##",".#..##.#.#","#...##....","##....#..#","##......##",".#...#....","..#....#..","....##....","#.#...#.#.","#.#.#..###"]),(3457,[".#########","#..#......","..##......","#.........",".#...#....",".###.....#",".......#.#",".........#","###....#..","#.......##"]),(1777,["###.#.####","#..#...###",".#.#..#..#",".......#..","#.#..##.##","..###.....","###......#",".#........","#.####....","##..######"]),(3613,["####.#...#","##.......#",".......##.","#....#...#","......##.#","...#.#..##","#......#..","...#...#..",".##..##...",".#...#..#."]),(3529,[".#.##.#...","##.....#.#","#...#..#..","......##.#","##..#.##.#","##........","#.....#...","...#...#..","...##.#...","..###....."]),(1153,["##.##.##..","..#####..#","##...#..#.",".......###",".#.......#","..#.#.....",".......#.#","#...#..###",".....#.#..",".#.##....#"]),(2467,["####....##","#..###...#","#####....#",".#......#.","###.......","##.......#",".##.#.#..#","....#.#...","#........#",".#..#.####"]),(3947,["#.##.##.#.","##.......#","......#..#","#...#..###",".....#.###","##..#..#..","...#.#...#","#...#....#",".......#.#","#...#..#.#"]),(1399,[".##.#..###","#.......#.","#.......#.",".....#..#.","#........#","##..#..#.#",".##..##..#","#..#......","#.....#..#","#.##..##.."]),(2879,["....###..#","..#.......","#...#.....","...#.#....",".........#",".##..#.##.",".#...###.#",".#.....#.#","..##.....#","##...#.#.."]),(1039,["#......#.#","##.##.###.",".....##..#","#........#","..#.......","#.........",".#..#.#.#.",".....###..","#....#####",".#.....###"]),(2777,["#..##...#.","....#....#","........#.","##.#....#.","..#.##...#",".#....#.#.","#....#....","#..#.#...#","#...##.#.#","#.......#."]),(1097,["##...###..","..#..####.","##....#.##","#.....##..","...#....##",".##..#....","#.##..###.","##...#....","#.###....#",".#.#.###.."]),(3793,["####.....#","..........",".#.##.#...","....#....#","#.....#...","..###..##.","##..#.#...","##........","#........#",".###......"]),(2689,["####...#..","..##....##","#.#....#.#",".....##..#","#.......##","#.........","#.....#..#","##........",".......#.#","#.###..#.#"])];

const MONSTER: [&str; 3] = [
  "                  # ",
  "#    ##    ##    ###",
  " #  #  #  #  #  #   ",
];

type BorderMap = HashMap<String, Vec<usize>>;

#[derive(Clone, Debug, Default)]
struct Tile(Vec<Vec<char>>, usize);

impl Tile {
  fn from_input(tile: &[&str], id: usize) -> Self {
    Self(tile.iter().map(|s| s.chars().collect()).collect(), id)
  }

  fn get_edges(&self) -> (String,String) {
    let (mut b1, mut b2) = (String::new(), String::new());
    for i in 0..10 {
      b1.push(self.0[i][0]);
      b2.push(self.0[i][9]);
    }
    (b1,b2)
  }

  fn get_neighbour(&self, border_map: &BorderMap, n: usize) -> Option<usize> {
    let matches = match n {
      0 => &border_map[&self.0[0].iter().copied().collect::<String>()],
      1 => &border_map[&self.get_edges().1],
      2 => &border_map[&self.0[9].iter().copied().collect::<String>()],
      3 => &border_map[&self.get_edges().0],
      _ => unreachable!()
    };
    matches.iter().find(|&&id| id != self.1).copied()
  }

  fn rotate(&mut self) { self.0 = rotate(&self.0) }

  fn match_right(&self, border_map: &BorderMap, images: &HashMap<usize, [&str;10]>) -> Self {
    let id = self.get_neighbour(border_map, 1).unwrap();
    let mut tile = Tile::from_input(&images[&id], id);

    // rotate it to the correct position
    while tile.get_neighbour(border_map, 3) != Some(self.1) { tile.rotate() }

    // the edges match but aren't equal, so it must be flipped!
    if (0..10).any(|i| self.0[i][9] != tile.0[i][0]) {
      for i in 0..5 { tile.0.swap(i, 9 - i) }
    }
    tile
  }

  fn match_down(&self, border_map: &BorderMap, images: &HashMap<usize, [&str;10]>) -> Self {
    let id = self.get_neighbour(border_map, 2).unwrap();
    let mut tile = Tile::from_input(&images[&id], id);

    // rotate it to the correct position
    while tile.get_neighbour(border_map, 0) != Some(self.1) { tile.rotate() }

    // the edges match but aren't equal, so it must be flipped!
    if self.0[9] != tile.0[0] {
      for s in &mut tile.0 { s.reverse() }
    }
    tile
  }
}

fn reverse_str(s: &str) -> String { s.chars().rev().collect() }

fn rotate(v: &[Vec<char>]) -> Vec<Vec<char>> {
  let (h,w) = (v.len(), v[0].len());
  let mut ans = vec![vec!['\0'; w]; h];
  for (i,j) in (0..h).cartesian_product(0..w) {
    ans[j][w-1-i] = v[i][j];
  }
  ans
}

fn build_image(border_map: &BorderMap, corner: usize) -> Vec<Vec<char>> {
  let images = IMAGES.iter().copied().collect::<HashMap<_,_>>();

  // align the corner to fit in the top-left
  let mut starting_corner = Tile::from_input(&images[&corner], corner);
  loop {
    let n1 = starting_corner.get_neighbour(border_map, 0);
    let n2 = starting_corner.get_neighbour(border_map, 3);
    match (n1,n2) {
      (None, None) => break,
      _ => starting_corner.rotate(),
    }
  }

  // for each row, match the first tile from the tile above
  // and then for all else match with the one left to it
  let mut image = vec![vec![Tile::default(); 12]; 12];
  image[0][0] = starting_corner;
  for (i,j) in (0..12).cartesian_product(0..12).skip(1) {
    image[i][j] = if j == 0 {
      image[i-1][0].match_down(border_map, &images)
    } else {
      image[i][j-1].match_right(border_map, &images)
    };
  }

  // have placed and rotated the tiles correctly, now build the actual image
  let mut actual_image = vec![Vec::new(); 8 * 12];
  for (i,j) in (0..12).cartesian_product(0..12) {
    let tile = &image[i][j];
    for k in 1..9 {
      actual_image[i * 8 + (k-1)].extend(&tile.0[k][1..9]);
    }
  }
  actual_image
}

fn find_monsters(image: &[Vec<char>], monster_coords: &HashSet::<(isize,isize)>) -> usize {
  let positions = image.iter()
    .enumerate()
    .flat_map(|(i,row)| row.iter()
      .enumerate()
      .filter(|&(_,&c)| c == '#')
      .map(move |(j,_)| (i as isize, j as isize))
    )
    .collect::<HashSet<_>>();
  positions.iter()
    .filter(|(i,j)| monster_coords.iter()
      .map(|(i2,j2)| (i+i2,j+j2))
      .all(|pos| positions.contains(&pos))
    )
    .count()
}

fn part_two(border_map: &BorderMap, corner: usize) -> usize {
  let monster_coords = MONSTER.iter()
    .enumerate()
    .flat_map(|(i,row)| row.chars()
      .enumerate()
      .filter(|&(_,c)| c == '#')
      .map(move |(j,_)| (i as isize - 1, j as isize))
    )
    .collect::<HashSet<_>>();
  let mut image = build_image(border_map, corner);
  let total = image.iter()
    .flatten()
    .filter(|&&c| c == '#')
    .count();
  loop {
    match find_monsters(&image, &monster_coords) {
      0 => image = rotate(&image),
      m => return total - m * monster_coords.len(),
    }
  }
}

fn part_one(border_map: &BorderMap) -> usize {
  let mut count_map = HashMap::new();
  for ids in border_map.values().filter(|ids| ids.len() == 1) {
    *count_map.entry(ids[0]).or_insert(0) += 1;
  }
  count_map.iter()
    .filter(|&(_, &c)| c == 4).map(|(id,_)| id)
    .product()
}

aoc2020::main! {
  let mut border_map = HashMap::new();
  for &(id,tile) in &IMAGES {
    let (b1,b2) = Tile::from_input(&tile, id).get_edges();
    border_map.entry(tile[0].to_string()).or_insert(Vec::new()).push(id);
    border_map.entry(tile[9].to_string()).or_insert(Vec::new()).push(id);
    border_map.entry(b1.clone()).or_insert(Vec::new()).push(id);
    border_map.entry(b2.clone()).or_insert(Vec::new()).push(id);
    border_map.entry(reverse_str(tile[0])).or_insert(Vec::new()).push(id);
    border_map.entry(reverse_str(tile[9])).or_insert(Vec::new()).push(id);
    border_map.entry(reverse_str(&b1)).or_insert(Vec::new()).push(id);
    border_map.entry(reverse_str(&b2)).or_insert(Vec::new()).push(id);
  }
  (part_one(&border_map), part_two(&border_map, 3517))
}
