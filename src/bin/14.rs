use std::time::Instant;
use std::collections::*;

static INPUT: [E; 560] = [E::Mask(b"X100110110X011000101000101XX11001X11"),E::Mem(5201,1838761),E::Mem(32099,25747352),E::Mem(36565,72187),E::Mem(31494,369864),E::Mem(17260,3138),E::Mem(64903,91484814),E::Mask(b"0X00100101000XX0011110X10110X100X010"),E::Mem(54866,120526),E::Mem(57614,430839),E::Mem(17916,648),E::Mem(43192,325890),E::Mem(23626,313518443),E::Mem(45988,50484),E::Mask(b"01001001X0001X00XXX110X010010XX0X001"),E::Mem(60805,1352),E::Mem(37516,5942314),E::Mem(63169,237020309),E::Mem(31655,274507),E::Mask(b"010011010001110000010000X101X0X11X01"),E::Mem(49875,15349586),E::Mem(6956,13765452),E::Mem(675,886107857),E::Mask(b"01000001X1XX11011X1111X111X000X01X11"),E::Mem(2135,5930),E::Mem(1861,1009),E::Mem(62754,145160),E::Mem(1333,1153712),E::Mem(15455,7454),E::Mask(b"01X01X011X0011X0X10110001X1X1000X110"),E::Mem(53253,667716),E::Mem(47571,745817),E::Mem(48582,5810),E::Mem(3620,7851685),E::Mem(41836,14080244),E::Mem(39150,84103),E::Mask(b"01001X01100X100010X111111X11100XX111"),E::Mem(249,514),E::Mem(25687,48545),E::Mem(62083,208926),E::Mem(39872,2590),E::Mem(28491,267),E::Mem(25340,115744),E::Mem(31101,6781),E::Mask(b"0100100100011101000XX001XX0010100X10"),E::Mem(6053,6291996),E::Mem(37941,514441),E::Mem(22984,108425255),E::Mem(30540,127685),E::Mask(b"000X100101011X1X1010X1011110XX10X1X0"),E::Mem(42567,253905),E::Mem(45241,15790),E::Mem(57132,480344),E::Mem(29971,22597051),E::Mask(b"XXX0111110001100010X1X01X10X0000000X"),E::Mem(44680,428361054),E::Mem(17571,4884),E::Mask(b"X1X001010X0111101X11X100X10100101100"),E::Mem(55107,2922),E::Mem(8605,5742),E::Mem(63754,289191),E::Mask(b"01101001010X11000110111X11000X01X000"),E::Mem(48186,7310),E::Mem(30306,413),E::Mem(1980,538481),E::Mask(b"010011011XX011X110011111101X01101X1X"),E::Mem(45241,11454771),E::Mem(65349,36152803),E::Mem(62368,34863),E::Mem(26794,5220),E::Mask(b"010X10XXX1001100011101X00X0110011110"),E::Mem(15496,898),E::Mem(59847,32170699),E::Mem(5411,130682),E::Mem(27017,205172),E::Mem(48688,3072),E::Mask(b"001X000X111X110000110XX0010100001110"),E::Mem(17575,12630818),E::Mem(51454,28544),E::Mem(52745,45251),E::Mask(b"000000010100X110X11101X101X1011010X1"),E::Mem(49456,637756),E::Mem(63169,99927),E::Mem(50318,7599616),E::Mem(42115,48825),E::Mem(20469,5931716),E::Mem(56899,2884),E::Mask(b"01XX100X0100X10001XX011111X000001XX0"),E::Mem(45630,2305),E::Mem(28560,118602807),E::Mem(45644,52185),E::Mem(3682,56264),E::Mem(63201,237495702),E::Mem(63572,7683),E::Mem(24477,370),E::Mask(b"01X0X0XX0X011100011110000X0XX00X1111"),E::Mem(14028,3492),E::Mem(28452,213847),E::Mem(57663,203516),E::Mem(24701,45071697),E::Mem(30226,856135),E::Mem(59279,100557),E::Mask(b"0110100001X0X1X0010XX1XX00X100000000"),E::Mem(4237,60693),E::Mem(51454,56389),E::Mem(44364,12145),E::Mem(53190,3825966),E::Mask(b"0X0010000X011X0011111001100010X10100"),E::Mem(45988,84435),E::Mem(43613,171165),E::Mem(39150,2025),E::Mask(b"000001010X111100111101001000X00X000X"),E::Mem(7204,243074994),E::Mem(30540,2829011),E::Mem(16986,171341),E::Mask(b"01101X0101001X101X1111110X0X01X0010X"),E::Mem(40006,276307),E::Mem(50601,45),E::Mem(2907,7955),E::Mem(61049,14014170),E::Mem(20722,52156072),E::Mem(12299,1701485),E::Mem(4643,2041760),E::Mask(b"X1101000010X110X0111X011001101000000"),E::Mem(29309,29638912),E::Mem(23626,127552394),E::Mem(39357,2743410),E::Mask(b"XXX01000000110001111101X101X1XX0XX01"),E::Mem(32322,110798340),E::Mem(38758,20398089),E::Mem(62368,6402),E::Mem(12381,125762),E::Mem(34042,46630),E::Mask(b"0X1X100X0X01100X11X11111101100100001"),E::Mem(56680,52806),E::Mem(3416,5097254),E::Mem(21217,959),E::Mem(11134,22705),E::Mem(39515,607),E::Mem(31858,527794383),E::Mask(b"011110010100X10001110111X0XXX00110X1"),E::Mem(37752,3783),E::Mem(27543,180509),E::Mem(56503,26998899),E::Mem(33984,2996098),E::Mem(6471,16602683),E::Mem(18585,5056811),E::Mem(3477,16274),E::Mask(b"010110011XXX110X01011XX11X0100110X00"),E::Mem(43993,784),E::Mem(12295,412860764),E::Mem(62707,11253),E::Mem(27017,1813664),E::Mask(b"1XX0X001010X1010101100X000X0100XX000"),E::Mem(25364,640),E::Mem(35537,489258314),E::Mem(356,47335),E::Mem(46814,130),E::Mem(21071,32074),E::Mem(23980,1969160),E::Mem(43457,28765451),E::Mask(b"0X0XX00110XX1X00X10111110011X01X1001"),E::Mem(37516,3409),E::Mem(32451,486160),E::Mem(31704,494261),E::Mem(64905,489121330),E::Mask(b"10001001X101111010X010X1X11X1001010X"),E::Mem(19927,125979),E::Mem(16164,163616),E::Mem(41291,11806544),E::Mem(13074,22666),E::Mem(65160,1102),E::Mem(21338,53735104),E::Mask(b"00X00101X10111XX111101XX10X111111100"),E::Mem(44736,13061),E::Mem(62844,31422),E::Mem(4643,59264),E::Mem(45417,5454),E::Mask(b"X0001X010X001101011X11001XX000101000"),E::Mem(33984,13200),E::Mem(15462,316464),E::Mem(2638,1434216),E::Mem(29044,1370180),E::Mem(57663,77699993),E::Mem(39191,9595034),E::Mask(b"100X1X0X010111X011101011111111XX1000"),E::Mem(60509,275540),E::Mem(65073,8066),E::Mem(64726,78129),E::Mem(15719,724),E::Mem(52499,43989105),E::Mem(57518,6805488),E::Mem(27827,1522993),E::Mask(b"0X010110X011X100111X00000111X1110X10"),E::Mem(395,16602),E::Mem(21477,62043769),E::Mem(24630,663408947),E::Mem(3983,31082032),E::Mem(30545,456250),E::Mask(b"0100XX01X000X10X10011101100X11101X10"),E::Mem(28174,110183887),E::Mem(9644,12911),E::Mem(62113,145),E::Mask(b"010010X10000100100110000101X1XX11011"),E::Mem(63016,127052),E::Mem(49130,37),E::Mem(25394,187810),E::Mem(29779,11708792),E::Mem(36144,1033),E::Mask(b"00101001X10XX10X11111X1100000111X001"),E::Mem(35746,498408),E::Mem(15462,7839193),E::Mem(5741,168870),E::Mask(b"0010100100X011XX1111X1001001X1X10101"),E::Mem(2256,10474689),E::Mem(57428,8228),E::Mem(34062,16609889),E::Mem(45031,106065),E::Mem(17162,138367053),E::Mem(23302,14262),E::Mask(b"001100110X1X11XX110100X0010100XX1000"),E::Mem(33186,1012027),E::Mem(34051,148436),E::Mem(4762,25019364),E::Mem(41825,102071658),E::Mem(32580,739),E::Mem(15455,151015),E::Mask(b"01X1XX00X10001000100011001000000XX10"),E::Mem(31330,300785),E::Mem(30222,206857068),E::Mem(27739,774225),E::Mem(47798,12155),E::Mem(57437,440075165),E::Mem(49892,58),E::Mem(44723,116116),E::Mask(b"100X1X00000X100011X1X00100101X00010X"),E::Mem(35368,5187),E::Mem(24769,1425443),E::Mem(62844,277),E::Mem(30729,11517370),E::Mask(b"0110100X0010110111X10X111000X11011X1"),E::Mem(63295,139),E::Mem(60805,381899),E::Mem(6956,3979616),E::Mem(12295,1828),E::Mask(b"010010X10X00X00X00X11XX00001X1001X00"),E::Mem(39150,459766),E::Mem(52621,1962),E::Mem(11891,5261559),E::Mask(b"X11011X11X00110001011X1X110010000000"),E::Mem(48473,3539),E::Mem(13808,331),E::Mem(30016,676),E::Mem(9736,3140258),E::Mem(12233,388562584),E::Mem(42686,1048145655),E::Mem(26132,67723),E::Mask(b"01001X0X010X0001001X10101111X10110X1"),E::Mem(35042,230878861),E::Mem(8611,488144),E::Mem(4290,942073),E::Mem(12381,17121117),E::Mem(15011,225),E::Mem(8378,9255),E::Mask(b"00001X0XX01X11X01101001101011110101X"),E::Mem(49708,312037855),E::Mem(19488,93439469),E::Mem(57113,7931),E::Mem(29037,210754),E::Mask(b"0100X001X0X01X0100110X11X110001110X1"),E::Mem(8519,38940),E::Mem(49033,10564),E::Mem(58481,4187786),E::Mem(5201,230275712),E::Mem(39296,886),E::Mask(b"1000100X010X11101X1011011X0110X11XXX"),E::Mem(38587,50240362),E::Mem(42581,116256847),E::Mem(37181,4441034),E::Mem(16281,23027479),E::Mem(32451,71649158),E::Mem(33316,6511),E::Mask(b"000001X11101111011X1X10X1X001X1X1000"),E::Mem(26168,390),E::Mem(11548,29301),E::Mem(2731,3188615),E::Mask(b"1100XX00X0X110001X111X000011X0X10001"),E::Mem(32136,6436),E::Mem(46206,225594),E::Mem(33132,7862942),E::Mem(15264,198),E::Mask(b"01001001000X1101000111011X0011XXX10X"),E::Mem(33733,14993993),E::Mem(9905,246637292),E::Mem(6373,2090),E::Mem(53539,29386),E::Mask(b"0X1010X1X01011XX11111100100XX110X00X"),E::Mem(41520,452041),E::Mem(8605,43647),E::Mem(62764,3241680),E::Mask(b"0X1X10X1010111X0X1110XXX00000110X001"),E::Mem(38517,3338),E::Mem(52745,4455),E::Mem(33218,850605),E::Mem(20495,315451),E::Mask(b"0XX0X001010X11X01X111X1101X11X101000"),E::Mem(32284,615642818),E::Mem(62844,46924),E::Mem(31120,146622),E::Mem(21925,518931),E::Mem(29515,1112),E::Mem(31241,130404),E::Mem(9905,5469165),E::Mask(b"01101000001X110X1101101110XX1X1XX101"),E::Mem(46432,346428972),E::Mem(64522,218092103),E::Mem(42311,2316477),E::Mem(20060,565),E::Mem(62919,261004),E::Mem(50103,42134),E::Mask(b"0101100101000100X1X01XX11X0X00111010"),E::Mem(41199,48367827),E::Mem(40992,886149),E::Mem(19927,93429),E::Mask(b"01001X01X0XX110X0XX1110X011110001101"),E::Mem(40019,187824261),E::Mem(3416,35491),E::Mem(51276,173825792),E::Mask(b"X100100110001X000X11010X00001010X001"),E::Mem(21071,3775434),E::Mem(41466,601899),E::Mem(29191,163888869),E::Mem(64981,1094832),E::Mem(36745,7560),E::Mem(44434,3179),E::Mem(5040,16142),E::Mask(b"0X101X011XX011111111010100010X0X01X0"),E::Mem(44140,22478),E::Mem(26863,31310307),E::Mem(56680,131716),E::Mem(3983,22050),E::Mask(b"1X0X10010X011X1X101X1000X1100X000010"),E::Mem(45724,5130),E::Mem(38747,147724),E::Mem(39515,58764331),E::Mask(b"0X001101X10000010X1X00010XX001010101"),E::Mem(50201,65493),E::Mem(44879,7688011),E::Mem(29782,85876639),E::Mem(63157,57556),E::Mask(b"00X00001010111X010X1X01X0101X01010XX"),E::Mem(37667,539),E::Mem(65058,928398),E::Mem(16037,2162946),E::Mask(b"X010100000X11X001111001011011001XX11"),E::Mem(20601,689238135),E::Mem(62832,22132331),E::Mem(20030,421255),E::Mem(38454,4898563),E::Mask(b"01101XX0000111X001111100011000X01111"),E::Mem(40968,287372),E::Mem(32860,121630361),E::Mem(6956,54910),E::Mask(b"01101001100X11X0010X0101101010001X11"),E::Mem(52270,852273185),E::Mem(44434,5773),E::Mem(40591,363113),E::Mem(31075,550),E::Mem(1148,237482),E::Mask(b"0110100000001100X111X111111010X00X10"),E::Mem(9807,919),E::Mem(10050,284353),E::Mem(11553,99307),E::Mask(b"11X1X0X0010001000101100X1XX10X100X10"),E::Mem(51707,59769),E::Mem(17916,456671254),E::Mem(15968,74716184),E::Mem(61681,11534),E::Mask(b"0X0010010000110X01X1X111X001X111100X"),E::Mem(63572,19584),E::Mem(12382,54348210),E::Mem(7204,62681),E::Mem(58309,718),E::Mask(b"XX0X0X11X0XX1100X10110111101X1000101"),E::Mem(19172,49321),E::Mem(3972,156574486),E::Mem(53411,371993),E::Mem(34118,1245490),E::Mem(63786,28834),E::Mem(44434,1679),E::Mask(b"0X010XX1101111001101110X1X0X1X1000X0"),E::Mem(65433,41829624),E::Mem(5383,3874764),E::Mem(58309,40586),E::Mem(34516,1861),E::Mask(b"0X00100X000X1100111X0011100010011100"),E::Mem(30691,6349),E::Mem(26045,2259746),E::Mem(35285,2525303),E::Mem(56918,64290918),E::Mem(34521,495146),E::Mem(41173,1892852),E::Mem(62708,2610505),E::Mask(b"X1001000010XX10001011X10101000011000"),E::Mem(41877,606935473),E::Mem(10746,30201),E::Mem(7236,2402617),E::Mem(31075,394149597),E::Mem(62893,2808512),E::Mem(44723,5738170),E::Mem(61147,2124552),E::Mask(b"01X0100X0X0X1100X1111X11X00X01X01001"),E::Mem(9905,376),E::Mem(56967,457904468),E::Mem(55040,2448),E::Mem(65513,2222),E::Mem(25340,23079),E::Mem(39876,4874),E::Mem(38909,16667453),E::Mask(b"X0001X0X01011110101X10XX1X1X10X01100"),E::Mem(19488,3061762),E::Mem(26132,292794),E::Mask(b"010010X101X01001001110X000X1011X11X0"),E::Mem(1980,12162025),E::Mem(37165,15333747),E::Mem(39210,152686),E::Mask(b"01X010X0010XX100011110000X000XX00101"),E::Mem(27917,944976),E::Mem(25099,11114),E::Mem(7777,577171),E::Mem(27080,16334871),E::Mem(14285,531),E::Mask(b"X1X0100001X01100X10X1111100X00111010"),E::Mem(28216,2511),E::Mem(37165,7141),E::Mem(55924,439753),E::Mem(11901,464),E::Mem(38571,407),E::Mem(782,10823),E::Mask(b"0XX00X01010111XX11111110XX010010000X"),E::Mem(54749,360481),E::Mem(20495,5280),E::Mem(37684,6039),E::Mem(6345,2073116),E::Mem(63110,22301539),E::Mask(b"X0X1010110111100110X1001100X1X100100"),E::Mem(20722,9600365),E::Mem(19084,76987),E::Mem(23777,740859),E::Mask(b"001X000111X01X000X11X000110111101100"),E::Mem(27917,52797296),E::Mem(57636,322),E::Mem(11553,70582),E::Mem(8605,30966411),E::Mem(25394,812862),E::Mem(48296,317),E::Mem(60466,1411129),E::Mask(b"X110000X0XXX11101111001X100110100000"),E::Mem(33339,4981),E::Mem(40073,5710720),E::Mem(33814,13208),E::Mem(14664,1950645),E::Mem(35042,35994943),E::Mask(b"10101000X0X1X0XXX1X1101011001100000X"),E::Mem(61417,114327),E::Mem(26863,706549),E::Mem(5651,118955),E::Mask(b"011X10000010110111X10111X1001100101X"),E::Mem(7679,272716),E::Mem(24077,12277996),E::Mask(b"X11XX000010001X00X011X1111X001XX0000"),E::Mem(46531,35092779),E::Mem(1116,11777757),E::Mem(5932,519743),E::Mem(36187,318),E::Mem(38758,718897339),E::Mask(b"01001X0110001000X0010X010010X01000X0"),E::Mem(31101,257),E::Mem(39813,30972074),E::Mem(23252,1761211),E::Mask(b"0X10100X00X0110X1111X1111010X1001101"),E::Mem(17132,2823025),E::Mem(62368,442239906),E::Mem(24553,339245),E::Mem(64751,66303),E::Mem(56967,870173),E::Mem(15383,342572184),E::Mem(1647,20517),E::Mask(b"00001XX000X11X0011X110X110XX1X010101"),E::Mem(16037,1478),E::Mem(33316,30615219),E::Mem(6729,209640491),E::Mask(b"01001000X1X1X100X1110100000X1X011X01"),E::Mem(62368,29355190),E::Mem(48784,1522851),E::Mem(26590,14698075),E::Mask(b"0XX0X0011X00X0000X11011010011110X101"),E::Mem(249,746),E::Mem(11553,236505210),E::Mem(38328,823888),E::Mem(58433,125568672),E::Mask(b"X000X0000101X1101X10110X000X00111100"),E::Mem(37813,4058843),E::Mem(32745,9417061),E::Mask(b"000XX110001111X01XX1XX01X00111110100"),E::Mem(22103,2397),E::Mem(40229,47978173),E::Mem(3477,14703),E::Mem(8594,2471),E::Mem(22603,44648051),E::Mem(11340,25471),E::Mask(b"000001X1010111001X11X1X1100XX0101X0X"),E::Mem(41160,52),E::Mem(2907,827),E::Mem(15719,107392281),E::Mem(43537,19084747),E::Mem(53742,3326211),E::Mem(46206,51870),E::Mem(30694,6031208),E::Mask(b"0X10100000011100111X11100010X1111X01"),E::Mem(31885,3110667),E::Mem(40041,30422),E::Mask(b"00XX0XX101X111XX11X10111001101001000"),E::Mem(2874,10110),E::Mem(21776,28380745),E::Mem(32004,7076),E::Mem(9644,526),E::Mask(b"011010110001X1000XX110X0X0110000X011"),E::Mem(35281,4670),E::Mem(7204,115940579),E::Mem(58380,17616),E::Mem(40735,46877007),E::Mem(30986,20371),E::Mask(b"0XX01001010010X100111010110001111X10"),E::Mem(43046,2060276),E::Mem(20743,553391345),E::Mem(20821,3685352),E::Mem(43943,39969),E::Mask(b"0010100101010X0011XXX01XX100XXX11111"),E::Mem(29261,60453),E::Mem(63512,94339357),E::Mem(34827,18871625),E::Mem(52359,322200),E::Mem(38003,25491),E::Mem(24795,461240689),E::Mask(b"0000010X01011100101X010100X1X1101010"),E::Mem(26894,3512),E::Mem(1023,9354),E::Mask(b"11010XXX100011001101011X1111011001X1"),E::Mem(45476,4571),E::Mem(2838,7601404),E::Mem(30540,187),E::Mask(b"X1X01X01X000110001011X010X0111X01001"),E::Mem(32944,381053),E::Mem(63110,7479218),E::Mem(59783,121082),E::Mem(56918,1237706),E::Mem(32355,472),E::Mem(44080,131839645),E::Mem(56680,38523)];

#[derive(Clone,Copy)]
enum E {
  Mem(usize, usize),
  Mask(&'static [u8]),
}

fn part_one() -> usize {
  let mut mem = HashMap::new();
  let mut mask: &[u8] = b"";
  for &op in &INPUT {
    match op {
      E::Mem(addr, value) => {
        let mut v = value;
        for (i,c) in mask.iter().enumerate() {
          match c {
            b'X' => {}
            b'0' => v &= !(1 << (35 - i)),
            b'1' => v |= 1 << (35 - i),
            _   => unreachable!(),
          }
        }
        mem.insert(addr, v);
      }
      E::Mask(m) => mask = m,
    }
  }
  mem.values().sum::<usize>()
}

fn write(
  mem: &mut HashMap<usize, usize>,
  mask: &[u8],
  addr: usize,
  value: usize,
  i: usize,
) {
  if i == 36 {
    mem.insert(addr, value);
    return;
  }
  match mask[i] {
    b'0' => write(mem, mask, addr, value, i+1),
    b'1' => {
      let a = addr | 1 << (35 - i);
      write(mem, mask, a, value, i+1)
    }
    b'X' => {
      let a1 = addr & !(1 << (35 - i));
      let a2 = addr | 1 << (35 - i);
      write(mem, mask, a1, value, i+1);
      write(mem, mask, a2, value, i+1);
    }
    _   => unreachable!(),
  }
}

fn part_two() -> usize {
  let mut mem = HashMap::new();
  let mut mask: &[u8] = b"";
  for &op in &INPUT {
    match op {
      E::Mask(m) => mask = m,
      E::Mem(addr, value) => write(&mut mem, mask, addr, value, 0),
    }
  }
  mem.values().sum::<usize>()
}

fn main() {
  let now = Instant::now();
  println!("Part one: {}", part_one());
  println!("Part two: {}", part_two());
  println!("Time: {}ms", now.elapsed().as_millis());
}
